var control=function(e){console.log("send",e),msg.show("Loading data..."),microAjax(e.url,function(t){renderTo(t,e.tplFile),msg.hide()},e.data)},njEnv=nunjucks.env,msg={getCont:function(){return document.querySelector(".msg")},hide:function(){console.log("msg",this,document.querySelector(this.cont)),this.getCont().innerHTML=""},show:function(e,t){if(console.log("msg",this),e){var n="";n=t?"alert-success":t===!1?"alert-error":"alert-info";var o=this.getCont();o&&(o.innerHTML='<span class="alert '+n+'">'+e+"</span>")}else this.hide()}},renderTo=function(e,t){if(console.log("client render",e,t),e.title&&(document.title=e.title,document.querySelector(".subheader").innerHTML=e.title),msg.show(e.msg,e.result),t){var n=njEnv.render(t,e),o=document.querySelector("main");console.log("client render",o,n),o.innerHTML=n;var s=document.querySelector("main form");s&&(s.onsubmit=function(e){e.preventDefault(),control({url:this.action,method:this.method,tplFile:t,data:serialize(this)}),console.log("onsumbit",this)})}},serialize=function(e){if(e&&"FORM"===e.nodeName){var t,n,o=[];for(t=e.elements.length-1;t>=0;t-=1)if(""!==e.elements[t].name)switch(e.elements[t].nodeName){case"INPUT":switch(e.elements[t].type){case"text":case"hidden":case"password":case"button":case"reset":case"submit":o.push(e.elements[t].name+"="+encodeURIComponent(e.elements[t].value));break;case"checkbox":case"radio":e.elements[t].checked&&o.push(e.elements[t].name+"="+encodeURIComponent(e.elements[t].value))}break;case"file":break;case"TEXTAREA":o.push(e.elements[t].name+"="+encodeURIComponent(e.elements[t].value));break;case"SELECT":switch(e.elements[t].type){case"select-one":o.push(e.elements[t].name+"="+encodeURIComponent(e.elements[t].value));break;case"select-multiple":for(n=e.elements[t].options.length-1;n>=0;n-=1)e.elements[t].options[n].selected&&o.push(e.elements[t].name+"="+encodeURIComponent(e.elements[t].options[n].value))}break;case"BUTTON":switch(e.elements[t].type){case"reset":case"submit":case"button":o.push(e.elements[t].name+"="+encodeURIComponent(e.elements[t].value))}}return o.join("&")}},microAjax=function(e,t,n){if(this.bindFunction=function(e,t){return function(){return e.apply(t,[t])}},this.stateChange=function(){4==this.request.readyState&&this.callbackFunction(JSON.parse(this.request.responseText))},this.getRequest=function(){return window.ActiveXObject?new ActiveXObject("Microsoft.XMLHTTP"):window.XMLHttpRequest?new XMLHttpRequest:!1},this.postBody=n||"",this.callbackFunction=t,this.url=e,this.request=this.getRequest(),this.request){var o=this.request;o.onreadystatechange=this.bindFunction(this.stateChange,this),""!==this.postBody?(o.open("POST",e,!0),o.setRequestHeader("Content-type","application/x-www-form-urlencoded"),o.setRequestHeader("Connection","close")):o.open("GET",e,!0),o.setRequestHeader("X-Requested-With","XMLHttpRequest"),o.send(this.postBody)}};routie({login:function(){control({url:"./?action=user_login",tplFile:"login.nj.html"})},logout:function(){control({url:"./?action=user_logout",method:"POST"})},reg:function(){control({url:"./?action=user_new",tplFile:"userCreate.nj.html"})},"user/:id":function(e){control({url:"./?action=user_edit&id="+parseInt(e),tplFile:"edit.nj.html"})},"new":function(){control({url:"./?action=entry_new",tplFile:"edit.nj.html"})},"msg/:id":function(e){control({url:"./?action=entry_edit&id="+parseInt(e),tplFile:"edit.nj.html"})},"msg/:id/delete":function(e){confirm("Do you really want to delete this message?")&&(control({url:"./?action=entry_delete&id="+parseInt(e),method:"POST"}),routie(""))},"":function(){console.log("default"),control({url:"./?action=entries",tplFile:"entryList.nj.html"})}});